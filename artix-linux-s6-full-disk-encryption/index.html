<!doctype html>
<html lang="en">
    <head>
        <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
        <meta content="text/html; charset=utf-8" http-equiv="content-type"/>
        <meta content="width=device-width, initial-scale=1" name="viewport"/>

        
        <meta name="robots" content="index,follow">
        <meta name="googlebot" content="index,follow">

        <meta name="google" content="nositelinkssearchbox">
        <meta name="google" content="notranslate">
        

        



        
        <link href="https://whoizit.github.io/style.css" rel="stylesheet"/>
        
        <title>
    Artix Linux s6 Full Disk Encryption - 
</title>
    </head>
    <body>
        <script>
            function evaluate_prefers_color() {
                if(localStorage.getItem('prefers-color') === 'dark') {
                    document.body.classList.add('dark');
                } else if(localStorage.getItem('prefers-color') === 'light') {
                    document.body.classList.remove('dark');
                } else if(window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark');
                }
            }
            evaluate_prefers_color();
        </script>
        
    <main class="article-content">
        <p><a href="..">..</a>/artix-linux-s6-full-disk-encryption</p>
        
        <h1>Artix Linux s6 Full Disk Encryption</h1>
        <p>Published: <time>2022-01-30</time></p>
        
        <hr />
        <p><em>(черновик)</em></p>
<h2 id="pochemu-s6">Почему s6?</h2>
<p>Системы инициализации Linux можно условно разделить на три вида (характерные черты):</p>
<ul>
<li>
<p>System 5, <strong>SysV</strong>-подобные (Upstart, OpenRC): скрипты запуска обычно имеют 4 SHELL функции - start(), stop(), restart(), reload()</p>
</li>
<li>
<p><strong>daemontools</strong>-подобные (daemontools-encore, runit, s6): примитивизм, простота, однострочники на SHELL, автоматический перезапуск</p>
</li>
<li>
<p><strong>launchd</strong>-подобные (Systemd, Suite66, nosh, Dinit): сервис-файлы в стиле ini (key=value)</p>
</li>
</ul>
<p>Что касается SystemD - многословность, неадекватно длинные команды, комбаин-всё в себе, более 1.3 млн строк кода (высокая vulnerability)</p>
<p>s6 это ремейк runit; runit это ремейк daemontools от гения современности, от великого математика-криптографа, от Хакера - DJB</p>
<p>s6 <a href="https://www.youtube.com/watch?v=mkkU1CHI3TY">самый быстрый получается</a></p>
<p>s6-rc (s6-db-reload) в отличии от всех выше-названных компилирует списки сервисов c их зависимостями в базу данных (compiled service database). Те секунды которые он экономит при загрузке могут быть неоспоримым преимуществом при активном использовании ноутбуков</p>
<h2 id="vybor-kripty">Выбор крипты</h2>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">cryptsetup</span><span> benchmark
</span></code></pre>
<p>Имейте ввиду что у меня benchmark показывает в 3 раза меньшие результаты в live ISO, чем в установленой системе с ядром linux-zen.</p>
<p>Считаю значения по умолчанию оптимальными (aes-xts-plain64:sha256:512b) и достаточно быстрыми (на моем древнем процессоре AMD FX-4300 это:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>~ &gt; cryptsetup benchmark
</span><span># Tests are approximate using memory only (no storage IO).
</span><span>PBKDF2-sha1      1190211 iterations per second for 256-bit key
</span><span>PBKDF2-sha256    1424695 iterations per second for 256-bit key
</span><span>PBKDF2-sha512    1227840 iterations per second for 256-bit key
</span><span>PBKDF2-ripemd160  691672 iterations per second for 256-bit key
</span><span>PBKDF2-whirlpool  382134 iterations per second for 256-bit key
</span><span>argon2i       4 iterations, 866287 memory, 4 parallel threads (CPUs) for 256-bit key (requested 2000 ms time)
</span><span>argon2id      4 iterations, 858144 memory, 4 parallel threads (CPUs) for 256-bit key (requested 2000 ms time)
</span><span>#     Algorithm |       Key |      Encryption |      Decryption
</span><span>        aes-cbc        128b       534.3 MiB/s      1795.6 MiB/s
</span><span>    serpent-cbc        128b        83.2 MiB/s       312.4 MiB/s
</span><span>    twofish-cbc        128b       179.4 MiB/s       241.3 MiB/s
</span><span>        aes-cbc        256b       406.3 MiB/s      1450.6 MiB/s
</span><span>    serpent-cbc        256b        87.4 MiB/s       313.5 MiB/s
</span><span>    twofish-cbc        256b       188.2 MiB/s       237.3 MiB/s
</span><span>        aes-xts        256b      1546.1 MiB/s      1543.9 MiB/s
</span><span>    serpent-xts        256b       277.3 MiB/s       291.6 MiB/s
</span><span>    twofish-xts        256b       223.9 MiB/s       227.5 MiB/s
</span><span>        aes-xts        512b      1306.2 MiB/s      1289.4 MiB/s
</span><span>    serpent-xts        512b       285.5 MiB/s       293.9 MiB/s
</span><span>    twofish-xts        512b       223.1 MiB/s       223.3 MiB/s
</span></code></pre>
<p>Если вы используете очень быстрый NVMe возможно это не для вас. Если используете SATA интерфейс, вы можете поставить более тяжелую крипту, например serpent-xts:argon2id:512b</p>
<h2 id="ustanovka">Установка</h2>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">fdisk -l</span><span> /dev/sdX
</span><span style="color:#65737e;"># BIOS/GPT
</span><span style="color:#65737e;"># sda1 = BIOS boot, 1M
</span><span style="color:#bf616a;">fdisk</span><span> /dev/sdX
</span><span>
</span><span style="color:#bf616a;">cryptsetup</span><span> luksFormat</span><span style="color:#bf616a;"> --type</span><span> luks1 /dev/sda2
</span><span style="color:#bf616a;">cryptsetup</span><span> open /dev/sda2 root
</span><span style="color:#bf616a;">mkfs.f2fs -lROOT</span><span> /dev/mapper/root
</span><span>
</span><span style="color:#bf616a;">mount</span><span> /dev/mapper/root /mnt
</span><span>
</span><span style="color:#bf616a;">basestrap</span><span> /mnt base base-devel s6-base elogind-s6 f2fs-tools \
</span><span>	linux-zen linux-zen-headers linux-firmware \
</span><span>	cryptsetup-s6 device-mapper-s6 lvm2-s6 vim dhcpcd wpa_supplicant
</span><span>
</span><span style="color:#65737e;"># TODO connman заменяет dhcpcd и ntpd. iwd заменяет wpa_supplicant no connman щас работает только с wpa_supplicant
</span><span>
</span><span style="color:#bf616a;">fstabgen -U</span><span> /mnt &gt;&gt; /mnt/etc/fstab
</span><span style="color:#bf616a;">blkid -s</span><span> UUID</span><span style="color:#bf616a;"> -o</span><span> value /dev/sdX2
</span><span style="color:#bf616a;">artix-chroot</span><span> /mnt bash
</span></code></pre>
<p>Имя и путь к файлу <code>/crypto_keyfile.bin</code> важны подробности в <code>4</code></p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">dd</span><span> bs=512 count=4 if=/dev/random of=/crypto_keyfile.bin iflag=fullblock
</span><span style="color:#bf616a;">chmod</span><span> 600 /crypto_keyfile.bin
</span><span style="color:#bf616a;">chmod</span><span> 600 /boot/initramfs-linux*
</span><span style="color:#bf616a;">cryptsetup</span><span> luksAddKey /dev/sdX# /crypto_keyfile.bin
</span></code></pre>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#65737e;"># /etc/mkinitcpio.conf
</span><span style="color:#bf616a;">FILES</span><span>=(/crypto_keyfile.bin)
</span><span style="color:#65737e;"># Добавить encrypt, resume и возможно lvm2 перед filesystems
</span><span style="color:#bf616a;">HOOKS</span><span>=(base udev autodetect modconf block encrypt lvm2 resume filesystems keyboard fsck)
</span></code></pre>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#65737e;"># /etc/default/grub
</span><span style="color:#bf616a;">GRUB_CMDLINE_LINUX_DEFAULT</span><span>=&quot;</span><span style="color:#a3be8c;">loglevel=3 quiet </span><span style="color:#96b5b4;">\
</span><span style="color:#a3be8c;">	cryptdevice=UUID=uuid-of-luks-partition:root </span><span style="color:#96b5b4;">\
</span><span style="color:#a3be8c;">	resume=UUID=uuid-of-swap-partition</span><span>&quot;
</span><span style="color:#bf616a;">GRUB_ENABLE_CRYPTODISK</span><span>=</span><span style="color:#a3be8c;">y
</span></code></pre>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">grub-install --target</span><span>=i386-pc /dev/sdX
</span><span style="color:#bf616a;">grub-mkconfig -o</span><span> /boot/grub/grub.cfg
</span><span style="color:#bf616a;">mkinitcpio -P
</span></code></pre>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#65737e;"># REBOOT
</span><span style="color:#bf616a;">pacman -Syu
</span><span style="color:#bf616a;">pacman -S</span><span> opendoas artix-archlinux-support 
</span><span style="color:#bf616a;">vim</span><span> /etc/pacman.conf
</span><span>
</span><span style="color:#bf616a;">pacman -S</span><span> git cargo rust atool \
</span><span>	sway swaylock seatd-s6 i3status-rust mako wl-clipboard \
</span><span>	firefox thunderbird keepassxc mpv yt-dlp
</span><span>
</span><span style="color:#bf616a;">cargo</span><span> install paru
</span></code></pre>
<p>Links:</p>
<ol>
<li><a href="https://wiki.artixlinux.org/Main/InstallationWithFullDiskEncryption">ArtixWiki: Installation With Full Disk Encryption</a></li>
<li><a href="https://wiki.archlinux.org/title/Partitioning#BIOS/GPT_layout_example">ArchWiki: Partitioning#BIOS/GPT_layout_example</a></li>
<li><a href="https://wiki.archlinux.org/title/GRUB#Encrypted_/boot">ArchWiki: GRUB#Encrypted_/boot</a></li>
<li><a href="https://wiki.archlinux.org/title/Dm-crypt/Device_encryption#With_a_keyfile_embedded_in_the_initramfs">ArchWiki: Device_encryption#With_a_keyfile_embedded_in_the_initramfs</a></li>
</ol>

    </main>

        <footer>
            <hr text="&copy; Copyright 2022" />
            
            <div class="footer-social-media">
                <a onclick="toggle_prefers_color()">Toggle Theme</a>
                
                    <a href="https://github.com/whoizit" target="_blank">GitHub</a>
                
                    <a href="https://qoto.org/@whoami" target="_blank">Mastodon</a>
                
                    <a href="https://whoizit.github.io/atom.xml" target="_blank">Feed</a>
                
            </div>
            
        </footer>
    </body>

    
        <script src="https://whoizit.github.io/js/script.js"/></script>
    
</html>